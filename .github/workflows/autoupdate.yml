name: Deploy and Update Algolia Search

# 触发条件：推送到main分支或手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-and-update:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出仓库代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # ==================== 第一部分：部署流程 ====================
      # 2. 设置Node.js环境（用于VitePress打包）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. 安装Node.js依赖
      - name: Install npm dependencies
        run: npm install

      # 4. 设置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 5. 安装Python依赖
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install paramiko tqdm

      # 6. 运行部署脚本
      - name: Run deployment script
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: python deploy.py

      # 7. 等待1分钟（确保服务器部署完成）
      - name: Wait for 1 minute
        run: sleep 60s

      # ==================== 第二部分：Algolia同步流程 ====================
      # 8. 获取docsearch配置
      - name: Get the content of docsearch.json as config
        id: algolia_config
        run: echo "::set-output name=config::$(cat docsearch.json | jq -r tostring)"

      # 9. 运行Algolia爬虫
      - name: Run algolia/docsearch-scraper image
        env:
          APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
          API_KEY: ${{ secrets.API_KEY }}
          CONFIG: ${{ steps.algolia_config.outputs.config }}
        run: |
          docker run \
            --env APPLICATION_ID=${APPLICATION_ID} \
            --env API_KEY=${API_KEY} \
            --env "CONFIG=${CONFIG}" \
            algolia/docsearch-scraper

      # 10. 上传部署日志（可选）
      - name: Upload deployment log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-log
          path: deploy_log.txt
